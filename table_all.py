import requests
import time
import json
import os
import logging
import psycopg2
from psycopg2 import sql
from datetime import datetime, timedelta

# --- LOG AYARLARI ---
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)

# --- KONFƒ∞G√úRASYON (AYARLAR) ---
CONFIG = {
    'database': {
        'host': "192.168.60.145",
        'port': 5432,
        'database': "mainview",
        'user': "postgres",
        'password': "12345678"
    },
    'api': {
        'protocol': "http",
        'address': "192.168.60.20",
        'port': 15565,
        'system': "MVERESTAPI_VBT1_3940",
        'products': "MVMVS",
        'username': "VOBA",
        'password': "OZAN1238" 
    }
}

# Veritabanƒ± tablo adlarƒ±
TABLE_WMSPLXZ = "mainview_mvs_wmsplxz"
TABLE_JESPOOL = "mainview_mvs_jespool"

# API URL'leri
LOGON_URL = "http://192.168.60.20:15565/cra/serviceGateway/services/MVERESTAPI_VBT1_3940/logon"
WMSPLXZ_DATA_URL = "http://192.168.60.20:15565/cra/serviceGateway/services/MVERESTAPI_VBT1_3940/products/MVMVS/views/WMSPLXZ/data"
JESPOOL_DATA_URL = "http://192.168.60.20:15565/cra/serviceGateway/services/MVERESTAPI_VBT1_3940/products/MVMVS/views/JESPOOL/data"

# Global deƒüi≈ükenler
api_token = None
MAX_ERRORS = 5
error_count_jespool = 0
error_count_wmsplxz = 0

# --- TOKEN ALMA ---
def get_token():
    global api_token
    logging.info("--- TOKEN ƒ∞≈ûLEMLERƒ∞ ---")
    logging.info("üîÑ Yeni token alƒ±nƒ±yor...")
    headers = {'Content-Type': 'application/x-www-form-urlencoded'}
    data = {
        "username": CONFIG['api']['username'],
        "password": CONFIG['api']['password']
    }
    try:
        response = requests.post(LOGON_URL, headers=headers, data=data, verify=False, timeout=10)
        response.raise_for_status()
        new_token = response.json().get("userToken")
        if new_token:
            api_token = new_token
            logging.info("‚úÖ Token ba≈üarƒ±yla alƒ±ndƒ±.")
            return True
        else:
            logging.error("‚ùå Token bulunamadƒ±. Yanƒ±t: %s", response.text)
            return False
    except requests.exceptions.RequestException as e:
        logging.error(f"‚ùå ƒ∞stek hatasƒ±: {e}")
        return False
    except ValueError as e:
        logging.error(f"‚ùå JSON √ß√∂z√ºmleme hatasƒ±: {e}")
        return False

# --- VERƒ∞ √áEKME ---
def fetch_api_data(url, view_name):
    if not api_token:
        logging.error(f"Token olmadan '{view_name}' verisi √ßekilemiyor.")
        return None
    headers = {'Authorization': f'Bearer {api_token}'}
    try:
        response = requests.get(url, headers=headers, verify=False, timeout=10)
        response.raise_for_status()
        api_data = response.json()
        logging.info(f"‚úÖ API'den '{view_name}' verisi ba≈üarƒ±yla √ßekildi.")
        return api_data
    except requests.exceptions.HTTPError as e:
        if e.response.status_code == 401:
            logging.warning("‚ö†Ô∏è Token s√ºresi dolmu≈ü veya ge√ßersiz. Yeniden kimlik doƒürulamasƒ± yapƒ±lacak.")
            return 'reauth'
        logging.error(f"‚ùå '{view_name}' API hatasƒ±: HTTP {e.response.status_code}")
        return None
    except requests.exceptions.RequestException as e:
        logging.error(f"‚ùå '{view_name}' veri √ßekme hatasƒ±: {e}")
        return None

# --- WMSPLXZ KAYDETME FONKSƒ∞YONU ---
def save_wmsplxz_data(data):
    global error_count_wmsplxz
    logging.info("--- WMSPLXZ VERƒ∞ ƒ∞≈ûLEME ---")
    if not data or not isinstance(data, dict) or 'Rows' not in data:
        logging.warning("‚ùå Ge√ßersiz veya bo≈ü WMSPLXZ verisi alƒ±ndƒ±. 'Rows' anahtarƒ± bekleniyor.")
        error_count_wmsplxz += 1
        return False

    records = data.get('Rows')
    if not records or not isinstance(records, list) or len(records) == 0:
        logging.warning("‚ùå WMSPLXZ verisi i≈ülenemedi. 'Rows' anahtarƒ± altƒ±nda liste bekleniyor.")
        error_count_wmsplxz += 1
        return False
    
    conn = None
    cursor = None
    try:
        conn = psycopg2.connect(**CONFIG['database'])
        cursor = conn.cursor()
        logging.info("Veritabanƒ±na baƒülantƒ± ba≈üarƒ±lƒ±.")
        for record in records:
            sysplex_name = record.get("SYGSPLX")
            
            system_name_list = record.get("SYGSYSN")
            system_name = system_name_list[1]['1'] if isinstance(system_name_list, list) and len(system_name_list) > 1 and '1' in system_name_list[1] else None

            wlm_velocity_flag = record.get("SYGFL2")
            
            performance_index_str = record.get("SYIPI")
            try:
                performance_index = float(performance_index_str) if performance_index_str else None
            except (ValueError, TypeError):
                performance_index = None

            install_datetime_list = record.get("SYGTDI")
            install_datetime_str = install_datetime_list[0]['0'] if isinstance(install_datetime_list, list) and len(install_datetime_list) > 0 and '0' in install_datetime_list[0] else None
            
            activate_datetime_list = record.get("SYGPTIM")
            activate_datetime_str = activate_datetime_list[0]['0'] if isinstance(activate_datetime_list, list) and len(activate_datetime_list) > 0 and '0' in activate_datetime_list[0] else None

            active_policy = record.get("SYGPNAM")
            
            install_datetime = None
            if install_datetime_str:
                try:
                    install_datetime = datetime.strptime(install_datetime_str.split('.')[0], '%Y/%m/%d %H:%M:%S')
                except ValueError:
                    logging.warning(f"‚ö†Ô∏è Ge√ßersiz zaman formatƒ±: '{install_datetime_str}'. NULL olarak kaydediliyor.")
            
            activate_datetime = None
            if activate_datetime_str:
                try:
                    activate_datetime = datetime.strptime(activate_datetime_str.split('.')[0], '%Y/%m/%d %H:%M:%S')
                except ValueError:
                    logging.warning(f"‚ö†Ô∏è Ge√ßersiz zaman formatƒ±: '{activate_datetime_str}'. NULL olarak kaydediliyor.")
            
            insert_query = sql.SQL("""
                INSERT INTO {table_name} (
                    sysplex_name,
                    system_name,
                    wlm_velocity_flag,
                    performance_index,
                    install_datetime,
                    active_policy,
                    activate_datetime,
                    record_timestamp
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s);
            """).format(table_name=sql.Identifier(TABLE_WMSPLXZ))
            values_to_insert = (
                sysplex_name,
                system_name,
                wlm_velocity_flag,
                performance_index,
                install_datetime,
                active_policy,
                activate_datetime,
                datetime.now()
            )
            cursor.execute(insert_query, values_to_insert)
        
        conn.commit()
        logging.info(f"‚úÖ {len(records)} WMSPLXZ kaydƒ± veritabanƒ±na ba≈üarƒ±yla eklendi.")
        error_count_wmsplxz = 0
        return True
    except (Exception, psycopg2.DatabaseError) as error:
        logging.error(f"‚ùå Veritabanƒ± hatasƒ±: {error}")
        error_count_wmsplxz += 1
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()
            logging.info("Veritabanƒ± baƒülantƒ±sƒ± kapatƒ±ldƒ±.")

# --- JESPOOL KAYDETME FONKSƒ∞YONU ---
def save_jespool_data(data):
    global error_count_jespool
    logging.info("--- JESPOOL VERƒ∞ ƒ∞≈ûLEME ---")
    if not data or 'Rows' not in data or not data['Rows']:
        logging.warning("‚ùå Ge√ßersiz veya bo≈ü JESPOOL verisi alƒ±ndƒ±.")
        error_count_jespool += 1
        return False

    records = data['Rows']
    
    conn = None
    cursor = None
    try:
        conn = psycopg2.connect(**CONFIG['database'])
        cursor = conn.cursor()
        logging.info("Veritabanƒ±na baƒülantƒ± ba≈üarƒ±lƒ±.")
        
        records_added = 0
        current_time = datetime.now().replace(microsecond=0)

        for record in records:
            smf_id = record.get('SCGID', '')
            
            select_query = sql.SQL("""
                SELECT id FROM {table_name}
                WHERE smf_id = %s AND DATE_TRUNC('minute', bmctime) = DATE_TRUNC('minute', %s)
            """).format(table_name=sql.Identifier(TABLE_JESPOOL))

            cursor.execute(select_query, (smf_id, current_time))
            
            if cursor.fetchone():
                continue

            insert_query = sql.SQL("""
                INSERT INTO {table_name}
                (bmctime, time, smf_id, total_volumes, spool_util, total_tracks,
                 used_tracks, active_spool_util, total_active_tracks, used_active_tracks,
                 active_volumes, volume, status, volume_util, volume_tracks, volume_used, other_volumes)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """).format(table_name=sql.Identifier(TABLE_JESPOOL))

            values_to_insert = (
                current_time,
                current_time.time(),
                record.get('SCGID', ''),
                record.get('SCIJ2VOL', ''),
                record.get('SCIUTI', ''),
                record.get('SCITKT', ''),
                record.get('SCITKTU', ''),
                record.get('SCIAUTI', ''),
                record.get('SCIATKT', ''),
                record.get('SCIATKTU', ''),
                record.get('SCIJ2ACT', ''),
                record.get('SCIVOL1', ''),
                record.get('SCISTS1', ''),
                record.get('SCIUTI1', ''),
                record.get('SCITKT1', ''),
                record.get('SCITKTU1', ''),
                record.get('SCIJ2OTH', '')
            )
            cursor.execute(insert_query, values_to_insert)
            records_added += 1

        conn.commit()
        if records_added > 0:
            logging.info(f"‚úÖ {records_added} JESPOOL kaydƒ± veritabanƒ±na ba≈üarƒ±yla eklendi.")
            error_count_jespool = 0
        else:
            logging.info("‚ÑπÔ∏è JESPOOL i√ßin yeni kayƒ±t bulunamadƒ±.")
        return True
    except (Exception, psycopg2.DatabaseError) as error:
        logging.error(f"‚ùå Veritabanƒ± hatasƒ±: {error}")
        error_count_jespool += 1
        return False
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()
            logging.info("Veritabanƒ± baƒülantƒ±sƒ± kapatƒ±ldƒ±.")

# --- ANA FONKSƒ∞YON ---
def main():
    global api_token, last_wmsplxz_run, error_count_jespool, error_count_wmsplxz
    
    if not get_token():
        logging.error("Token alƒ±namadƒ±. Program sonlandƒ±rƒ±lƒ±yor.")
        return

    JESPOOL_INTERVAL_SECONDS = 60
    WMSPLXZ_INTERVAL_SECONDS = 2 * 60 * 60
    
    # JESPOOL ve WMSPLXZ'nin ilk √ßalƒ±≈ütƒ±rmada hemen ba≈ülamalarƒ± i√ßin zamanƒ± ge√ßmi≈üe ayarla
    last_jespool_run = datetime.now() - timedelta(seconds=JESPOOL_INTERVAL_SECONDS)
    last_wmsplxz_run = datetime.now() - timedelta(seconds=WMSPLXZ_INTERVAL_SECONDS)

    while True:
        try:
            # JESPOOL verilerini 60 saniyede bir i≈üle
            if (datetime.now() - last_jespool_run).total_seconds() >= JESPOOL_INTERVAL_SECONDS:
                logging.info("\n" + "="*40 + "\n--- JESPOOL Verileri ƒ∞≈üleniyor (60 saniye d√∂ng√ºs√º) ---")
                
                jespool_data = fetch_api_data(JESPOOL_DATA_URL, "JESPOOL")
                if jespool_data == 'reauth':
                    if not get_token():
                        logging.error("Yeniden token alma ba≈üarƒ±sƒ±z. Program sonlandƒ±rƒ±lƒ±yor.")
                        return
                    jespool_data = fetch_api_data(JESPOOL_DATA_URL, "JESPOOL")
                
                if jespool_data:
                    save_jespool_data(jespool_data)
                
                last_jespool_run = datetime.now()

            # WMSPLXZ verilerini 2 saatte bir i≈üle
            if (datetime.now() - last_wmsplxz_run).total_seconds() >= WMSPLXZ_INTERVAL_SECONDS:
                logging.info("\n" + "="*40 + "\n--- WMSPLXZ Verileri ƒ∞≈üleniyor (2 saatlik d√∂ng√º) ---")
                
                wmsplxz_data = fetch_api_data(WMSPLXZ_DATA_URL, "WMSPLXZ")
                if wmsplxz_data == 'reauth':
                    if not get_token():
                        logging.error("Yeniden token alma ba≈üarƒ±sƒ±z. Program sonlandƒ±rƒ±lƒ±yor.")
                        return
                    wmsplxz_data = fetch_api_data(WMSPLXZ_DATA_URL, "WMSPLXZ")
                
                if wmsplxz_data:
                    save_wmsplxz_data(wmsplxz_data)
                
                last_wmsplxz_run = datetime.now()
            
            if error_count_jespool >= MAX_ERRORS or error_count_wmsplxz >= MAX_ERRORS:
                logging.error(f"üî¥ Maksimum hata sayƒ±sƒ±na ula≈üƒ±ldƒ±. JESPOOL hatalarƒ±: {error_count_jespool}, WMSPLXZ hatalarƒ±: {error_count_wmsplxz}. Program sonlandƒ±rƒ±lƒ±yor.")
                return

            # Kontrol d√∂ng√ºs√º i√ßin bekleme s√ºresi (60 saniye)
            # D√ºzeltme: 10 saniyelik mikro bekleme yerine 60 saniyelik ana bekleme.
            logging.info(f"‚è≥ 60 saniye bekleniyor... ({datetime.now().strftime('%Y-%m-%d %H:%M:%S')})")
            time.sleep(60)

        except KeyboardInterrupt:
            logging.info("üõë Kullanƒ±cƒ± tarafƒ±ndan durduruldu.")
            break
        except Exception as e:
            logging.error(f"‚ùå Beklenmeyen bir hata olu≈ütu: {e}")
            time.sleep(30)

if __name__ == "__main__":
    main()